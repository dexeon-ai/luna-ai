<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Luna AI — Control Panel</title>

  <!-- Your existing CSS and Plotly. Do not change order. -->
  <link rel="stylesheet" href="/static/css/control_panel.css?v=2">
  <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
</head>

<body>
  <div class="shell">
    <header class="topbar">
      <strong>Luna AI — Control Panel</strong>
      <form class="go-line" method="get" action="/analyze">
        <input type="text" name="symbol" id="symbol" value="{{ symbol_raw }}" placeholder="Search coin / contract…" />
        <select name="tf" id="tf">
          {% for t in ['1h','4h','8h','12h','24h','7d','30d','1y'] %}
            <option value="{{t}}" {% if t==tf %}selected{% endif %}>{{t}}</option>
          {% endfor %}
        </select>
        <button type="submit">Apply</button>
        <button type="button" id="refreshBtn" title="Force refresh cache">Refresh</button>
      </form>
      <div class="updated">Updated {{ updated }} · Build {{ build }}</div>
    </header>

    <!-- Performance chips (null-safe) -->
    <section class="panel row-compact">
      <header><strong>Performance</strong></header>
      <div class="chips">
        {% for k in ['1h','4h','8h','12h','24h','7d','30d','1y'] %}
          {% set v = performance.get(k) %}
          <span class="chip">{{ k }}: {{ 'n/a' if v is none else ('%+.2f%%'|format(v)) }}</span>
        {% endfor %}
      </div>
    </section>

    <!-- Investment chips (null-safe) -->
    <section class="panel row-compact">
      <header><strong>Investment ($1000 model)</strong></header>
      <div class="chips">
        {% for k in ['1h','4h','8h','12h','24h','7d','30d','1y'] %}
          {% set v = investment.get(k) %}
          <span class="chip">{{ k }}: {{ '$—' if v is none else ('$%0.2f'|format(v)) }}</span>
        {% endfor %}
      </div>
    </section>

    <!-- Main grid (your existing CSS controls size/placement) -->
    <section class="grid">
      <article class="tile" data-key="RSI">
        <header>RSI <button class="expand" data-key="RSI">Expand</button></header>
        <div class="tile__body">{{ tiles['RSI']|safe }}</div>
      </article>

      <article class="tile tile--price" data-key="PRICE">
        <header>{{ symbol }} — Charts <button class="expand" data-key="PRICE">Expand</button></header>
        <div class="tile__body">{{ tiles['PRICE']|safe }}</div>
      </article>

      <article class="tile" data-key="MCAP">
        <header>Market Cap <button class="expand" data-key="MCAP">Expand</button></header>
        <div class="tile__body">{{ tiles['MCAP']|safe }}</div>
      </article>

      <article class="tile" data-key="MACD">
        <header>MACD <button class="expand" data-key="MACD">Expand</button></header>
        <div class="tile__body">{{ tiles['MACD']|safe }}</div>
      </article>

      <article class="tile" data-key="OBV">
        <header>OBV <button class="expand" data-key="OBV">Expand</button></header>
        <div class="tile__body">{{ tiles['OBV']|safe }}</div>
      </article>

      <article class="tile" data-key="ATR">
        <header>Volatility (ATR 14) <button class="expand" data-key="ATR">Expand</button></header>
        <div class="tile__body">{{ tiles['ATR']|safe }}</div>
      </article>

      <article class="tile" data-key="BANDS">
        <header>Bands <button class="expand" data-key="BANDS">Expand</button></header>
        <div class="tile__body">{{ tiles['BANDS']|safe }}</div>
      </article>

      <article class="tile" data-key="VOL">
        <header>Volume Trend <button class="expand" data-key="VOL">Expand</button></header>
        <div class="tile__body">{{ tiles['VOL']|safe }}</div>
      </article>

      <article class="tile" data-key="LIQ">
        <header>Liquidity <button class="expand" data-key="LIQ">Expand</button></header>
        <div class="tile__body">{{ tiles['LIQ']|safe }}</div>
      </article>

      <article class="tile" data-key="ADX">
        <header>ADX <button class="expand" data-key="ADX">Expand</button></header>
        <div class="tile__body">{{ tiles['ADX']|safe }}</div>
      </article>

      <article class="tile" data-key="ALT">
        <header>ALT (Momentum) <button class="expand" data-key="ALT">Expand</button></header>
        <div class="tile__body">{{ tiles['ALT']|safe }}</div>
      </article>
    </section>

    <!-- TL;DR -->
    <section class="row">
      <article class="panel">
        <header><strong>TL;DR</strong></header>
        <div>{{ tldr_line }}</div>
      </article>
    </section>

    <!-- Ask Luna -->
    <section class="row">
      <article class="panel qa">
        <header><strong>Questions</strong></header>
        <div id="qaQ"></div>
      </article>
      <article class="panel qa">
        <header><strong>Luna’s answers</strong></header>
        <div id="qaA"></div>
        <div class="ask-line">
          <input id="askBox" placeholder="Ask Luna about {{ symbol }}…">
          <button id="askSend">Ask</button>
        </div>
      </article>
    </section>
  </div>

  <!-- Expand modal (unchanged structure) -->
  <div id="modal" class="hidden">
    <div class="m-box">
      <div class="m-head">
        <div><strong id="m-title">Expand</strong>
          <select id="m-tf">
            {% for t in ['1h','4h','8h','12h','24h','7d','30d','1y'] %}
              <option value="{{t}}" {% if t==tf %}selected{% endif %}>{{t}}</option>
            {% endfor %}
          </select>
        </div>
        <button id="m-close">Close</button>
      </div>
      <div class="m-body">
        <div class="m-chart" id="m-chart"></div>
        <aside class="m-aside">
          <h4>What this shows</h4>
          <div id="m-talk"></div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Provide the variables your JS expects -->
  <script>
    const SYMBOL      = {{ (symbol or '')|tojson }};
    const SYMBOL_RAW  = {{ (symbol_raw or '')|tojson }};  /* <- this line fixed: always defined */
    const TF_DEFAULT  = {{ (tf or '12h')|tojson }};
  </script>

  <!-- Inline JS (kept minimal and compatible with your existing IDs/classes) -->
  <script>
    (function () {
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));

      // Refresh (respects server TTL)
      $("#refreshBtn")?.addEventListener("click", () => {
        fetch(`/api/refresh/${encodeURIComponent(SYMBOL_RAW || SYMBOL)}`)
          .then(() => window.location.reload());
      });

      // Expand modal
      const modal = $("#modal"), mClose = $("#m-close"), mChart = $("#m-chart"), mTalk = $("#m-talk"), mTf = $("#m-tf");
      let currentKey = null;
      function openModal(key) {
        currentKey = key;
        modal.classList.remove("hidden");
        const s = SYMBOL_RAW || SYMBOL;
        fetch(`/expand_json?symbol=${encodeURIComponent(s)}&key=${encodeURIComponent(key)}&tf=${encodeURIComponent(mTf.value)}`)
          .then(r => r.json())
          .then(j => {
            mChart.innerHTML = "";
            Plotly.newPlot(mChart, j.fig.data, j.fig.layout || {}, {responsive: true});
            mTalk.textContent = j.talk || "";
          })
          .catch(err => { mTalk.textContent = "Error loading chart."; console.error(err); });
      }
      function closeModal(){ modal.classList.add("hidden"); }
      mClose.addEventListener("click", closeModal);
      modal.addEventListener("click", e => { if (e.target === modal) closeModal(); });
      mTf.addEventListener("change", () => { if (currentKey) openModal(currentKey); });
      $$(".expand").forEach(btn => btn.addEventListener("click", () => openModal(btn.dataset.key)));

      // Ask Luna
      const askBox=$("#askBox"), askSend=$("#askSend"), qaQ=$("#qaQ"), qaA=$("#qaA");
      function pushQA(q, a){
        if(q){ const li=document.createElement("div"); li.className="bubble q"; li.textContent="• "+q; qaQ.appendChild(li); qaQ.scrollTop=qaQ.scrollHeight; }
        if(a){ const li=document.createElement("div"); li.className="bubble a"; li.textContent=a; qaA.appendChild(li); qaA.scrollTop=qaA.scrollHeight; }
      }
      askSend?.addEventListener("click", ()=>{
        const q=(askBox.value||"").trim(); if(!q) return;
        pushQA(q,null); askBox.value="";
        fetch("/api/luna",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({symbol:SYMBOL_RAW||SYMBOL, tf: $("#tf")?.value || TF_DEFAULT, text:q})})
          .then(r=>r.json()).then(j=>pushQA(null,j.reply)).catch(err=>pushQA(null,"Error: "+String(err)));
      });
    })();
  </script>
</body>
</html>
