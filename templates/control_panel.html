<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Luna AI — Control Panel</title>

  <!-- Plotly (needed before tiles because tiles contain inline init from pio.to_html) -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

  <link rel="stylesheet" href="/static/app.css?v=2025-11-05"/>
</head>
<body class="luna">

  <!-- ===== Top bar ===== -->
  <header class="topbar">
    <div class="left">
      <div class="brand">Luna AI — <span>Control Panel</span></div>

      <div class="tfs">
        {% set TFs = ['1h','4h','8h','12h','24h','7d','30d','3mo','6mo','9mo','1y','all'] %}
        {% for t in TFs %}
          <a class="chip {{ 'sel' if tf==t else '' }}" href="/analyze?symbol={{ symbol_raw|default(symbol, true)|urlencode }}&tf={{ t }}">{{ t }}</a>
        {% endfor %}
      </div>
    </div>

    <div class="right">
      <form class="search" action="/analyze" method="get">
        <input type="text" name="symbol" placeholder="Search coin / contract…" value="{{ symbol_raw|default(symbol, true) }}" />
        <select name="tf">
          {% for t in TFs %}
            <option value="{{ t }}" {{ 'selected' if tf==t else '' }}>{{ t }}</option>
          {% endfor %}
        </select>
        <button class="go" type="submit">Go</button>
      </form>

      <div class="updated">Updated: {{ updated }}</div>

      <div class="height">
        <label for="hslider">Height</label>
        <input id="hslider" type="range" min="320" max="560" step="10" value="420"/>
      </div>
    </div>
  </header>

  <!-- ===== Perf strip ===== -->
  <section class="perf-strip">
    {% macro pct(v) -%}{% if v is none %}n/a{% else %}{{ '%+.2f%%'|format(v) }}{% endif %}{%- endmacro %}
    {% set labels = ['1h','4h','8h','12h','24h','7d','30d','3mo','6mo','9mo','1y','all'] %}
    {% for k in labels %}
      <div class="chip perf">
        <div class="lab">{{ k }}</div>
        <div class="val">{{ pct(performance.get(k)) }}</div>
      </div>
    {% endfor %}
  </section>

  <!-- ===== Investment strip (optional) ===== -->
  <section class="invest-strip">
    {% for k,v in investment.items() %}
      <div class="chip inv">
        <div class="lab">{{ k }}</div>
        <div class="val">${{ '%.2f'|format(v/1000.0) }}k</div>
      </div>
    {% endfor %}
  </section>

  <!-- ===== Grid ===== -->
  <main class="grid12">

    <!-- Left small: RSI -->
    <div class="tile small" id="tile-rsi">
      <div class="head"><span>RSI</span><button class="expand" data-key="RSI">Expand</button></div>
      <div class="body">{{ tiles['RSI']|safe }}</div>
    </div>

    <!-- Center big: PRICE -->
    <div class="tile big" id="tile-price">
      <div class="head">
        <span class="symbol">{{ symbol }}</span>
        <div class="actions">
          <button id="toggleCap" class="muted" title="Toggle Cap/Price">Cap/Price</button>
          <button id="toggleScale" class="muted" title="Toggle Log/Lin">Log/Lin</button>
          <button class="expand" data-key="PRICE">Expand</button>
        </div>
      </div>
      <div class="body">{{ tiles['PRICE']|safe }}</div>
    </div>

    <!-- Right small: Market Cap -->
    <div class="tile small" id="tile-mcap">
      <div class="head"><span>Market Cap</span><button class="expand" data-key="MCAP">Expand</button></div>
      <div class="body">{{ tiles['MCAP']|safe }}</div>
    </div>

    <!-- Row of small tiles -->
    <div class="tile small" id="tile-macd">
      <div class="head"><span>MACD</span><button class="expand" data-key="MACD">Expand</button></div>
      <div class="body">{{ tiles['MACD']|safe }}</div>
    </div>

    <div class="tile small" id="tile-liq">
      <div class="head"><span>Liquidity</span><button class="expand" data-key="LIQ">Expand</button></div>
      <div class="body">{{ tiles['LIQ']|safe }}</div>
    </div>

    <div class="tile small" id="tile-vol">
      <div class="head"><span>Volume Trend</span><button class="expand" data-key="VOL">Expand</button></div>
      <div class="body">{{ tiles['VOL']|safe }}</div>
    </div>

    <div class="tile small" id="tile-obv">
      <div class="head"><span>OBV</span><button class="expand" data-key="OBV">Expand</button></div>
      <div class="body">{{ tiles['OBV']|safe }}</div>
    </div>

    <div class="tile small" id="tile-adx">
      <div class="head"><span>ADX</span><button class="expand" data-key="ADX">Expand</button></div>
      <div class="body">{{ tiles['ADX']|safe }}</div>
    </div>

    <div class="tile small" id="tile-bands">
      <div class="head"><span>Bands</span><button class="expand" data-key="BANDS">Expand</button></div>
      <div class="body">{{ tiles['BANDS']|safe }}</div>
    </div>

    <!-- ALT momentum & ATR (optional extras) -->
    <div class="tile small" id="tile-atr">
      <div class="head"><span>ATR</span><button class="expand" data-key="ATR">Expand</button></div>
      <div class="body">{{ tiles['ATR']|safe }}</div>
    </div>

    <div class="tile small" id="tile-alt">
      <div class="head"><span>ALT (Momentum)</span><button class="expand" data-key="ALT">Expand</button></div>
      <div class="body">{{ tiles['ALT']|safe }}</div>
    </div>

  </main>

  <!-- ===== TL;DR ===== -->
  <section class="tldr">
    {{ tldr_line }}
  </section>

  <!-- ===== Ask Luna ===== -->
  <section class="ask">
    <div class="head">Ask Luna about {{ symbol }}</div>
    <div class="row">
      <input id="askInput" type="text" placeholder="e.g., Is this bearish next 24h? Is this a rug? What coin is this?"/>
      <button id="askSend">Send</button>
      <button id="askReset" class="muted">Reset</button>
      <span class="small grey">0 / 21</span>
    </div>
    <div id="answer" class="answer"></div>
  </section>

  <!-- ===== Modal for Expand ===== -->
  <div id="modal" class="modal hidden">
    <div class="dialog">
      <button id="modalClose" class="close">×</button>
      <div id="modalPlot"></div>
    </div>
  </div>

  <!-- Environment for JS -->
  <script>
    const SYMBOL_RAW = {{ symbol_raw|default(symbol, true)|tojson }};
    const TF         = {{ tf|tojson }};
    const URL_BASE   = "/expand_json";
  </script>
  <script src="/static/app.js?v=2025-11-05"></script>
</body>
</html>
