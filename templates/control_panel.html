<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Luna AI — Control Panel</title>

  <!-- Cache-bust CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/control_panel.css') }}?v={{ build|default('v') }}">
  <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
</head>

<body data-symbol="{{ symbol }}" data-tf-default="{{ tf }}">
  <div class="shell">

    <!-- ░░░ TOPBAR ░░░ -->
    <header class="topbar">
      <strong>Luna AI — Control Panel</strong>
      <form class="go-line" method="get" action="/analyze">
        <select name="symbol" id="symbol">
          {% for s in ['BTC','ETH','SOL','BNB','XRP','ADA','DOGE','LINK','AVAX','TON'] %}
            <option value="{{s}}" {% if s==symbol %}selected{% endif %}>{{s}}</option>
          {% endfor %}
        </select>
        <select name="tf" id="tf">
          {% for t in ['1h','4h','8h','12h','24h','7d','30d','1y'] %}
            <option value="{{t}}" {% if t==tf %}selected{% endif %}>{{t}}</option>
          {% endfor %}
        </select>
        <button type="submit">Apply</button>
        <button type="button" id="refreshBtn">Refresh</button>
        <input id="searchBox" name="symbol" placeholder="Search coin or contract..." />
        <button type="submit" id="goBtn">Go</button>
      </form>
      <div class="updated">Updated {{ updated }}</div>
    </header>

    <!-- ░░░ PERFORMANCE ░░░ -->
    <section class="panel row-compact">
      <header><strong>Performance</strong></header>
      <div class="chips">
        {% for k in ['1h','4h','8h','12h','24h','7d','30d','1y'] %}
          <span class="chip">{{ k }}:
            {{ 'n/a' if performance.get(k) is none else ('%+.2f%%'|format(performance.get(k))) }}
          </span>
        {% endfor %}
      </div>
    </section>

    <!-- ░░░ INVESTMENT ░░░ -->
    <section class="panel row-compact">
      <header><strong>Investment ($1000 model)</strong></header>
      <div class="chips">
        {% for k in ['1h','4h','8h','12h','24h','7d','30d','1y'] %}
          <span class="chip">{{ k }}:
            {{ '$—' if investment.get(k) is none else ('$%0.2f'|format(investment.get(k))) }}
          </span>
        {% endfor %}
      </div>
    </section>

    <!-- ░░░ MAIN GRID ░░░ -->
    <section class="grid">
      <!-- Left -->
      <article class="tile" data-key="RSI">
        <header>RSI <button class="expand" data-key="RSI">Expand</button></header>
        <div class="tile__body">{{ tiles['RSI']|safe }}</div>
      </article>

      <!-- Price (4×wide, 2×tall) -->
      <article class="tile tile--price" data-key="PRICE">
        <header>{{ symbol }} — Charts <button class="expand" data-key="PRICE">Expand</button></header>
        <div class="tile__body">{{ tiles['PRICE']|safe }}</div>
      </article>

      <!-- Right column -->
      <article class="tile" data-key="MCAP">
        <header>Market Cap <button class="expand" data-key="MCAP">Expand</button></header>
        <div class="tile__body">{{ tiles['MCAP']|safe }}</div>
      </article>

      <article class="tile" data-key="MACD">
        <header>MACD <button class="expand" data-key="MACD">Expand</button></header>
        <div class="tile__body">{{ tiles['MACD']|safe }}</div>
      </article>

      <article class="tile" data-key="OBV">
        <header>OBV <button class="expand" data-key="OBV">Expand</button></header>
        <div class="tile__body">{{ tiles['OBV']|safe }}</div>
      </article>

      <!-- Lower row -->
      <article class="tile" data-key="ATR">
        <header>Volatility (ATR 14) <button class="expand" data-key="ATR">Expand</button></header>
        <div class="tile__body">{{ tiles['ATR']|safe }}</div>
      </article>

      <article class="tile" data-key="BANDS">
        <header>Bands <button class="expand" data-key="BANDS">Expand</button></header>
        <div class="tile__body">{{ tiles['BANDS']|safe }}</div>
      </article>

      <article class="tile" data-key="VOL">
        <header>Volume Trend <button class="expand" data-key="VOL">Expand</button></header>
        <div class="tile__body">{{ tiles['VOL']|safe }}</div>
      </article>

      <article class="tile" data-key="LIQ">
        <header>Liquidity <button class="expand" data-key="LIQ">Expand</button></header>
        <div class="tile__body">{{ tiles['LIQ']|safe }}</div>
      </article>

      <article class="tile" data-key="ADX">
        <header>ADX <button class="expand" data-key="ADX">Expand</button></header>
        <div class="tile__body">{{ tiles['ADX']|safe }}</div>
      </article>

      <article class="tile" data-key="ALT">
        <header>ALT (Momentum) <button class="expand" data-key="ALT">Expand</button></header>
        <div class="tile__body">{{ tiles['ALT']|safe }}</div>
      </article>
    </section>

    <!-- ░░░ TL;DR + FEAR & GREED ░░░ -->
    <section class="row">
      <article class="panel tldr">
        <header><strong>TL;DR</strong></header>
        <div>{{ tldr_line }}</div>
      </article>
      <article class="panel fg">
        <header><strong>Fear & Greed</strong></header>
        <div class="bar"><div class="fill" style="width:50%"></div></div>
        <div>50 / 100</div>
      </article>
    </section>

    <!-- ░░░ Q&A ░░░ -->
    <section class="row">
      <article class="panel qa">
        <header><strong>Questions</strong></header>
        <div id="qaQ"></div>
      </article>

      <article class="panel qa">
        <header><strong>Luna’s answers</strong></header>
        <div id="qaA"></div>
        <div class="ask-line">
          <input id="askBox" placeholder="Ask Luna about {{symbol}}…">
          <button id="askSend">Ask</button>
        </div>
      </article>
    </section>

  </div><!-- /shell -->

  <!-- ░░░ EXPAND MODAL ░░░ -->
  <div id="modal" class="hidden">
    <div class="m-box">
      <div class="m-head">
        <div>
          <strong id="m-title">Expand</strong>
          <select id="m-tf">
            {% for t in ['1h','4h','8h','12h','24h','7d','30d','1y'] %}
              <option value="{{t}}" {% if t==tf %}selected{% endif %}>{{t}}</option>
            {% endfor %}
          </select>
        </div>
        <button id="m-close">Close</button>
      </div>
      <div class="m-body">
        <div class="m-chart" id="m-chart"></div>
        <aside class="m-aside">
          <h4>What this shows</h4>
          <div id="m-talk"></div>
        </aside>
      </div>
    </div>
  </div>

  <!-- ░░░ SCRIPTS ░░░ -->
  <script>
    window.__SYMBOL__ = "{{ symbol }}";
    window.__TF__     = "{{ tf }}";
  </script>
  <script src="{{ url_for('static', filename='js/control_panel.js') }}?v={{ build|default('v') }}"></script>
</body>
</html>
